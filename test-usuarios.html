<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema de Usuarios - Mundo Calzado</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .test-section { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-title { font-size: 1.2em; font-weight: bold; color: #1a355e; margin-bottom: 10px; }
        .test-result { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 15px; margin: 5px; background: #1a355e; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #2a4a7e; }
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .stats-table th { background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Sistema de Test - Gestión de Usuarios</h1>
        
        <div class="test-section">
            <div class="test-title">Estado del Sistema</div>
            <div id="system-status"></div>
            <button onclick="verificarSistema()">Verificar Sistema</button>
        </div>

        <div class="test-section">
            <div class="test-title">Pruebas del Gestor de Usuarios</div>
            <div id="test-results"></div>
            <button onclick="ejecutarPruebas()">Ejecutar Pruebas</button>
            <button onclick="limpiarDatos()">Limpiar Datos de Prueba</button>
        </div>

        <div class="test-section">
            <div class="test-title">Estadísticas de Usuarios</div>
            <div id="user-stats"></div>
            <button onclick="mostrarEstadisticas()">Actualizar Estadísticas</button>
        </div>

        <div class="test-section">
            <div class="test-title">Usuarios Registrados</div>
            <div id="users-list"></div>
            <button onclick="mostrarUsuarios()">Mostrar Usuarios</button>
            <button onclick="exportarUsuarios()">Exportar JSON</button>
        </div>

        <div class="test-section">
            <div class="test-title">Migración de Datos</div>
            <div id="migration-status"></div>
            <button onclick="migrarDatos()">Ejecutar Migración</button>
        </div>
    </div>

    <script src="js/gestor-usuarios.js"></script>
    <script>
        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            return `<div class="test-result ${type}">${message}</div>`;
        }

        function verificarSistema() {
            const statusDiv = document.getElementById('system-status');
            let status = '';

            // Verificar si el gestor está disponible
            if (window.gestorUsuarios) {
                status += log('✅ Gestor de usuarios cargado correctamente', 'success');
                
                // Verificar métodos principales
                const metodos = ['obtenerUsuarios', 'agregarUsuario', 'obtenerUsuarioPorEmail', 'validarDatosUsuario'];
                metodos.forEach(metodo => {
                    if (typeof window.gestorUsuarios[metodo] === 'function') {
                        status += log(`✅ Método ${metodo} disponible`, 'success');
                    } else {
                        status += log(`❌ Método ${metodo} no encontrado`, 'error');
                    }
                });
            } else {
                status += log('❌ Gestor de usuarios no está disponible', 'error');
            }

            // Verificar localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                status += log('✅ localStorage funcionando', 'success');
            } catch (e) {
                status += log('❌ localStorage no funciona: ' + e.message, 'error');
            }

            statusDiv.innerHTML = status;
        }

        function ejecutarPruebas() {
            const resultsDiv = document.getElementById('test-results');
            let results = '';

            if (!window.gestorUsuarios) {
                results += log('❌ No se puede ejecutar las pruebas sin el gestor', 'error');
                resultsDiv.innerHTML = results;
                return;
            }

            // Prueba 1: Agregar usuario válido
            const usuarioTest = {
                nombre: 'Juan',
                apellido: 'Pérez',
                email: 'juan.test@ejemplo.com',
                cedula: '12345678',
                telefono: '3001234567',
                genero: 'Masculino',
                fecha: '1990-05-15',
                boletin: true
            };

            const errores = window.gestorUsuarios.validarDatosUsuario(usuarioTest);
            if (errores.length === 0) {
                results += log('✅ Validación de datos correcta', 'success');
            } else {
                results += log('❌ Errores de validación: ' + errores.join(', '), 'error');
            }

            // Prueba 2: Agregar usuario
            const agregado = window.gestorUsuarios.agregarUsuario(usuarioTest);
            if (agregado) {
                results += log('✅ Usuario agregado correctamente', 'success');
            } else {
                results += log('❌ Error al agregar usuario', 'error');
            }

            // Prueba 3: Buscar usuario
            const encontrado = window.gestorUsuarios.obtenerUsuarioPorEmail(usuarioTest.email);
            if (encontrado && encontrado.email === usuarioTest.email) {
                results += log('✅ Usuario encontrado por email', 'success');
            } else {
                results += log('❌ Usuario no encontrado', 'error');
            }

            // Prueba 4: Validación de datos inválidos
            const usuarioInvalido = { nombre: '', email: 'email-invalido', cedula: '123' };
            const erroresInvalido = window.gestorUsuarios.validarDatosUsuario(usuarioInvalido);
            if (erroresInvalido.length > 0) {
                results += log('✅ Validación detecta datos inválidos correctamente', 'success');
            } else {
                results += log('❌ Validación no detecta datos inválidos', 'error');
            }

            // Prueba 5: Sesión de usuario
            const sesionEstablecida = window.gestorUsuarios.establecerUsuarioActivo({
                name: usuarioTest.nombre + ' ' + usuarioTest.apellido,
                email: usuarioTest.email
            });
            if (sesionEstablecida) {
                results += log('✅ Sesión de usuario establecida', 'success');
                
                const usuarioActivo = window.gestorUsuarios.obtenerUsuarioActivo();
                if (usuarioActivo && usuarioActivo.email === usuarioTest.email) {
                    results += log('✅ Usuario activo recuperado correctamente', 'success');
                } else {
                    results += log('❌ Error al recuperar usuario activo', 'error');
                }
            } else {
                results += log('❌ Error al establecer sesión', 'error');
            }

            resultsDiv.innerHTML = results;
        }

        function limpiarDatos() {
            if (window.gestorUsuarios) {
                window.gestorUsuarios.cerrarSesion();
                localStorage.removeItem('usuariosRegistrados');
                document.getElementById('test-results').innerHTML = log('✅ Datos de prueba limpiados', 'success');
                mostrarEstadisticas();
            }
        }

        function mostrarEstadisticas() {
            const statsDiv = document.getElementById('user-stats');
            
            if (!window.gestorUsuarios) {
                statsDiv.innerHTML = log('❌ Gestor no disponible', 'error');
                return;
            }

            const stats = window.gestorUsuarios.obtenerEstadisticas();
            
            let statsHTML = '<table class="stats-table">';
            statsHTML += '<tr><th>Métrica</th><th>Valor</th></tr>';
            statsHTML += `<tr><td>Total de usuarios</td><td>${stats.total}</td></tr>`;
            statsHTML += `<tr><td>Con teléfono</td><td>${stats.conTelefono}</td></tr>`;
            statsHTML += `<tr><td>Suscritos al boletín</td><td>${stats.suscritos}</td></tr>`;
            statsHTML += `<tr><td>Con dirección</td><td>${stats.conDireccion}</td></tr>`;
            statsHTML += `<tr><td>Personas jurídicas</td><td>${stats.personasJuridicas}</td></tr>`;
            statsHTML += '</table>';

            statsDiv.innerHTML = statsHTML;
        }

        function mostrarUsuarios() {
            const usersDiv = document.getElementById('users-list');
            
            if (!window.gestorUsuarios) {
                usersDiv.innerHTML = log('❌ Gestor no disponible', 'error');
                return;
            }

            const usuarios = window.gestorUsuarios.obtenerUsuarios();
            
            if (usuarios.length === 0) {
                usersDiv.innerHTML = log('ℹ️ No hay usuarios registrados', 'info');
                return;
            }

            let usersHTML = '<table class="stats-table">';
            usersHTML += '<tr><th>Nombre</th><th>Email</th><th>Teléfono</th><th>Boletín</th></tr>';
            
            usuarios.forEach(user => {
                usersHTML += `<tr>
                    <td>${user.nombre || ''} ${user.apellido || ''}</td>
                    <td>${user.email || ''}</td>
                    <td>${user.telefono || 'N/A'}</td>
                    <td>${user.boletin ? 'Sí' : 'No'}</td>
                </tr>`;
            });
            
            usersHTML += '</table>';
            usersDiv.innerHTML = usersHTML;
        }

        function migrarDatos() {
            const migrationDiv = document.getElementById('migration-status');
            
            if (!window.gestorUsuarios) {
                migrationDiv.innerHTML = log('❌ Gestor no disponible', 'error');
                return;
            }

            try {
                const usuariosMigrados = window.gestorUsuarios.migrarDatosExistentes();
                migrationDiv.innerHTML = log(`✅ Migración completada: ${usuariosMigrados.length} usuarios procesados`, 'success');
                mostrarEstadisticas();
                mostrarUsuarios();
            } catch (error) {
                migrationDiv.innerHTML = log('❌ Error en migración: ' + error.message, 'error');
            }
        }

        function exportarUsuarios() {
            if (!window.gestorUsuarios) {
                alert('Gestor no disponible');
                return;
            }

            const usuarios = window.gestorUsuarios.obtenerUsuarios();
            const contenidoJSON = JSON.stringify(usuarios, null, 2);
            
            const blob = new Blob([contenidoJSON], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'usuarios_registrados_backup.json';
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Ejecutar verificación inicial
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                verificarSistema();
                mostrarEstadisticas();
            }, 500);
        });
    </script>
</body>
</html>
