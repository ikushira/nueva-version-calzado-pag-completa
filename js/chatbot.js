// Chatbot con IA para Mundo Calzado
class MundoCalzadoChatbot {
    constructor() {
        this.isOpen = false;
        this.messages = [];
        this.productDatabase = this.initializeProductDatabase();
        this.init();
    }

    init() {
        this.createChatbotHTML();
        this.bindEvents();
        this.addWelcomeMessage();
    }

    createChatbotHTML() {
        // Crear el bot√≥n flotante del chatbot
        const chatbotButton = document.createElement('div');
        chatbotButton.className = 'chatbot-float';
        chatbotButton.id = 'chatbot-button';
        chatbotButton.innerHTML = '<img src="assets/img/chatbot-robot.svg" alt="Asistente Virtual">';
        document.body.appendChild(chatbotButton);

        // Crear el modal del chatbot
        const chatbotModal = document.createElement('div');
        chatbotModal.className = 'chatbot-modal';
        chatbotModal.id = 'chatbot-modal';
        chatbotModal.innerHTML = `
            <div class="chatbot-container">
                <div class="chatbot-header">
                    <h3>ü§ñ Asistente de Mundo Calzado</h3>
                    <button class="chatbot-close" id="chatbot-close">&times;</button>
                </div>
                <div class="chatbot-messages" id="chatbot-messages">
                    <div class="chatbot-typing" id="chatbot-typing">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
                <div class="chatbot-input-container">
                    <input type="text" class="chatbot-input" id="chatbot-input" 
                           placeholder="Escribe tu pregunta sobre nuestros productos...">
                    <button class="chatbot-send" id="chatbot-send">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(chatbotModal);
    }

    bindEvents() {
        const chatbotButton = document.getElementById('chatbot-button');
        const chatbotModal = document.getElementById('chatbot-modal');
        const chatbotClose = document.getElementById('chatbot-close');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotSend = document.getElementById('chatbot-send');

        chatbotButton.addEventListener('click', () => this.toggleChat());
        chatbotClose.addEventListener('click', () => this.closeChat());
        chatbotSend.addEventListener('click', () => this.sendMessage());
        chatbotInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.sendMessage();
        });

        // Cerrar al hacer click fuera del chat
        chatbotModal.addEventListener('click', (e) => {
            if (e.target === chatbotModal) this.closeChat();
        });
    }

    toggleChat() {
        if (this.isOpen) {
            this.closeChat();
        } else {
            this.openChat();
        }
    }

    openChat() {
        document.getElementById('chatbot-modal').style.display = 'block';
        document.getElementById('chatbot-input').focus();
        this.isOpen = true;
    }

    closeChat() {
        document.getElementById('chatbot-modal').style.display = 'none';
        this.isOpen = false;
    }

    addWelcomeMessage() {
        const welcomeMessage = "¬°Hola! üëã Soy tu asistente virtual de Mundo Calzado. Estoy aqu√≠ para ayudarte a encontrar el calzado perfecto. ¬øEn qu√© puedo asistirte hoy?";
        this.addMessage('bot', welcomeMessage);
    }

    sendMessage() {
        const input = document.getElementById('chatbot-input');
        const message = input.value.trim();
        
        if (!message) return;

        this.addMessage('user', message);
        input.value = '';
        
        this.showTyping();
        setTimeout(() => {
            this.hideTyping();
            const response = this.generateResponse(message);
            this.addMessage('bot', response);
        }, 1000 + Math.random() * 1000);
    }

    addMessage(type, text) {
        const messagesContainer = document.getElementById('chatbot-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chatbot-message ${type}`;
        messageDiv.textContent = text;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    showTyping() {
        document.getElementById('chatbot-typing').style.display = 'block';
        const messagesContainer = document.getElementById('chatbot-messages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    hideTyping() {
        document.getElementById('chatbot-typing').style.display = 'none';
    }

    generateResponse(userMessage) {
        const message = userMessage.toLowerCase();
        
        // Saludos
        if (this.matchesAny(message, ['hola', 'buenas', 'buenos d√≠as', 'buenas tardes', 'buenas noches', 'saludos'])) {
            return this.getRandomResponse([
                "¬°Hola! Bienvenido a Mundo Calzado. ¬øEn qu√© puedo ayudarte hoy?",
                "¬°Buenos d√≠as! ¬øBuscas alg√∫n tipo de calzado en particular?",
                "¬°Hola! Estoy aqu√≠ para ayudarte a encontrar el calzado perfecto. ¬øQu√© necesitas?"
            ]);
        }

        // Productos por categor√≠a
        if (this.matchesAny(message, ['hombres', 'hombre', 'masculino', 'caballero'])) {
            return "Tenemos una excelente selecci√≥n de calzado para hombres: zapatos formales, deportivos, botas, mocasines y m√°s. Nuestras marcas incluyen Croydon, Patrick, y 24 Walks. ¬øQu√© tipo espec√≠fico buscas?";
        }

        if (this.matchesAny(message, ['mujeres', 'mujer', 'femenino', 'dama'])) {
            return "Nuestra colecci√≥n para mujeres es incre√≠ble: tacones, flats, sandalias, botas, deportivos y m√°s. Contamos con marcas como Piccadilly, Moleca, Frattini e Ipanema. ¬øQu√© estilo prefieres?";
        }

        if (this.matchesAny(message, ['ni√±os', 'ni√±o', 'infantil', 'escolar'])) {
            return "¬°Tenemos calzado perfecto para ni√±os! Zapatos escolares, deportivos y casuales. Nuestras marcas Bubblegummers y Gumball son ideales para los peque√±os. ¬øPara qu√© ocasi√≥n necesitas el calzado?";
        }

        if (this.matchesAny(message, ['ni√±as', 'ni√±a'])) {
            return "Para ni√±as tenemos una hermosa colecci√≥n: zapatos escolares, sandalias, deportivos y casuales. Las marcas Bubblegummers y Gumball ofrecen dise√±os encantadores y c√≥modos. ¬øQu√© tipo buscas?";
        }

        // Marcas espec√≠ficas
        if (this.matchesAny(message, ['croydon'])) {
            return "Croydon es una de nuestras marcas premium para hombres, conocida por su calidad y elegancia en zapatos formales y casuales. Perfectos para el trabajo y ocasiones especiales.";
        }

        if (this.matchesAny(message, ['piccadilly'])) {
            return "Piccadilly es una marca brasile√±a reconocida mundialmente por su comodidad y estilo para mujeres. Perfecta para el d√≠a a d√≠a con tecnolog√≠a de confort avanzada.";
        }

        if (this.matchesAny(message, ['bubblegummers'])) {
            return "Bubblegummers es nuestra marca especializada en calzado infantil, dise√±ada especialmente para brindar comodidad y diversi√≥n a los ni√±os. ¬°Perfecta para el colegio y el juego!";
        }

        // Tallas
        if (this.matchesAny(message, ['talla', 'tallas', 'medida', 'medidas', 'tama√±o'])) {
            return "Manejamos tallas desde la 21 hasta la 45, dependiendo del modelo y marca. Te recomiendo visitar nuestra gu√≠a de tallas en la p√°gina para encontrar tu medida exacta. ¬øNecesitas ayuda con alguna talla espec√≠fica?";
        }

        // Precios
        if (this.matchesAny(message, ['precio', 'precios', 'costo', 'valor', 'cu√°nto', 'cuanto'])) {
            return "Nuestros precios var√≠an seg√∫n la marca y el modelo. Tenemos opciones desde $50.000 hasta $300.000. Siempre manejamos promociones especiales. ¬øTe interesa alg√∫n producto en particular para darte un precio espec√≠fico?";
        }

        // Ofertas y promociones
        if (this.matchesAny(message, ['oferta', 'ofertas', 'promoci√≥n', 'promociones', 'descuento', 'rebaja'])) {
            return "¬°Siempre tenemos ofertas especiales! Visita nuestra secci√≥n de ofertas donde encontrar√°s descuentos de hasta el 40%. Tambi√©n manejamos promociones por compras m√∫ltiples. ¬øTe gustar√≠a conocer las ofertas actuales?";
        }

        // Env√≠os
        if (this.matchesAny(message, ['env√≠o', 'envios', 'domicilio', 'entrega', 'delivery'])) {
            return "Realizamos env√≠os a todo el pa√≠s. En la ciudad tenemos entrega el mismo d√≠a para pedidos antes de las 2 PM. Para otras ciudades, el tiempo es de 2-5 d√≠as h√°biles. ¬°El env√≠o es GRATIS en compras superiores a $150.000!";
        }

        // Devoluciones
        if (this.matchesAny(message, ['devoluci√≥n', 'devoluciones', 'cambio', 'cambios', 'garant√≠a'])) {
            return "Aceptamos cambios y devoluciones dentro de los 30 d√≠as siguientes a la compra, siempre que el producto est√© en perfecto estado. La garant√≠a cubre defectos de fabricaci√≥n por 6 meses.";
        }

        // Deportivos
        if (this.matchesAny(message, ['deportivos', 'deportivo', 'tenis', 'zapatillas', 'running'])) {
            return "Tenemos una amplia gama de calzado deportivo para toda la familia. Marcas como Patrick y 24 Walks ofrecen tecnolog√≠a de punta para correr, caminar y hacer ejercicio. ¬øPara qu√© deporte espec√≠fico los necesitas?";
        }

        // Formales
        if (this.matchesAny(message, ['formales', 'formal', 'oficina', 'trabajo', 'elegante'])) {
            return "Nuestros zapatos formales son perfectos para el trabajo y ocasiones especiales. Croydon y Frattini ofrecen dise√±os cl√°sicos y modernos en cuero genuino. ¬øPrefieres algo cl√°sico o m√°s moderno?";
        }

        // Comodidad
        if (this.matchesAny(message, ['c√≥modo', 'c√≥modos', 'comodidad', 'confort'])) {
            return "La comodidad es nuestra prioridad. Piccadilly y Moleca son reconocidas por su tecnolog√≠a de confort. Tambi√©n recomendamos nuestros modelos con plantillas anat√≥micas. ¬øSufres de alg√∫n problema espec√≠fico en los pies?";
        }

        // Colores
        if (this.matchesAny(message, ['color', 'colores', 'negro', 'caf√©', 'marr√≥n', 'blanco'])) {
            return "Manejamos una amplia variedad de colores: negro, caf√©, marr√≥n, blanco, y muchos m√°s seg√∫n la temporada. Los colores cl√°sicos como negro y caf√© est√°n siempre disponibles. ¬øQu√© color espec√≠fico buscas?";
        }

        // Material
        if (this.matchesAny(message, ['cuero', 'material', 'sint√©tico', 'piel'])) {
            return "Trabajamos con cuero genuino de alta calidad y materiales sint√©ticos duraderos. El cuero natural lo encuentras en nuestras l√≠neas premium como Croydon y Frattini. ¬øTienes preferencia por alg√∫n material espec√≠fico?";
        }

        // Contacto y ubicaci√≥n
        if (this.matchesAny(message, ['ubicaci√≥n', 'direcci√≥n', 'd√≥nde', 'donde', 'tienda', 'local'])) {
            return "Puedes visitarnos en nuestra tienda f√≠sica o comprar en l√≠nea. Para conocer nuestra ubicaci√≥n exacta, puedes contactarnos por WhatsApp. ¬°Tambi√©n realizamos env√≠os a domicilio!";
        }

        // Ayuda general
        if (this.matchesAny(message, ['ayuda', 'ay√∫dame', 'no s√©', 'no se', 'qu√© recomiendas', 'que recomiendas'])) {
            return "¬°Claro! Estoy aqu√≠ para ayudarte. Puedo asesorarte sobre nuestros productos, tallas, precios, env√≠os y m√°s. ¬øPodr√≠as contarme qu√© tipo de calzado buscas y para qu√© ocasi√≥n? As√≠ te dar√© la mejor recomendaci√≥n.";
        }

        // Agradecimientos
        if (this.matchesAny(message, ['gracias', 'thank you', 'perfecto', 'excelente', 'muy bien'])) {
            return this.getRandomResponse([
                "¬°De nada! Estoy aqu√≠ para ayudarte siempre que lo necesites.",
                "¬°Es un placer ayudarte! ¬øHay algo m√°s en lo que pueda asistirte?",
                "¬°Perfecto! Si necesitas m√°s informaci√≥n, no dudes en preguntarme."
            ]);
        }

        // Despedidas
        if (this.matchesAny(message, ['adi√≥s', 'adios', 'chao', 'bye', 'hasta luego', 'nos vemos'])) {
            return "¬°Hasta pronto! Gracias por visitar Mundo Calzado. ¬°Espero haberte ayudado a encontrar el calzado perfecto! üëû‚ú®";
        }

        // Respuesta por defecto con sugerencias
        return this.getDefaultResponse();
    }

    matchesAny(text, keywords) {
        return keywords.some(keyword => text.includes(keyword));
    }

    getRandomResponse(responses) {
        return responses[Math.floor(Math.random() * responses.length)];
    }

    getDefaultResponse() {
        const suggestions = [
            "Puedo ayudarte con informaci√≥n sobre nuestros productos para hombres, mujeres, ni√±os y ni√±as.",
            "Te puedo contar sobre nuestras marcas: Croydon, Piccadilly, Frattini, Moleca, Patrick, Bubblegummers y m√°s.",
            "Puedo asesorarte sobre tallas, precios, ofertas, env√≠os y devoluciones.",
            "¬øTe interesa calzado deportivo, formal, casual o para alguna ocasi√≥n espec√≠fica?"
        ];

        return `Lo siento, no entend√≠ completamente tu pregunta. ${this.getRandomResponse(suggestions)} ¬øPodr√≠as ser m√°s espec√≠fico sobre lo que buscas?`;
    }

    initializeProductDatabase() {
        return {
            categories: ['hombres', 'mujeres', 'ni√±os', 'ni√±as', 'ofertas'],
            brands: ['croydon', 'piccadilly', 'frattini', 'moleca', 'patrick', 'bubblegummers', 'gumball', 'ipanema', 'cartago', '24walks', 'stardus'],
            types: ['deportivos', 'formales', 'casuales', 'botas', 'sandalias', 'tacones', 'flats', 'mocasines'],
            sizes: Array.from({length: 25}, (_, i) => i + 21), // Tallas 21-45
            materials: ['cuero', 'sint√©tico', 'textil', 'lona']
        };
    }
}

// Inicializar el chatbot cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Peque√±o delay para asegurar que todos los elementos est√©n cargados
    setTimeout(() => {
        new MundoCalzadoChatbot();
    }, 500);
});

// Exportar para uso en otros scripts si es necesario
window.MundoCalzadoChatbot = MundoCalzadoChatbot;
